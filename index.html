<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® Ultimate Anime Game Bot ‚ú®</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            /* Default Dark Theme */
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #e6e6e6;
            --accent-1: #ff6b9e;
            --accent-2: #6b47ff;
            --card-bg: rgba(30, 30, 46, 0.8);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --border: 1px solid rgba(255, 255, 255, 0.1);
            --bg-image: url('https://i.imgur.com/X6QX0yT.png');
            --game-btn-text: white;
            --success: #4caf50;
            --error: #f44336;
        }

        /* Bright Theme */
        .bright-theme {
            --bg-primary: #f5f5fa;
            --bg-secondary: #e6e6f0;
            --text-primary: #33334d;
            --text-secondary: #4d4d66;
            --accent-1: #ff3366;
            --accent-2: #6633ff;
            --card-bg: rgba(255, 255, 255, 0.9);
            --shadow: 0 8px 32px rgba(102, 51, 255, 0.1);
            --border: 1px solid rgba(0, 0, 0, 0.1);
            --bg-image: url('https://i.imgur.com/Lw7JYrQ.png');
        }

        /* Base Styles */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: var(--bg-image);
            background-size: cover;
            background-attachment: fixed;
            transition: all 0.3s ease;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: var(--border);
        }

        .title {
            font-size: 2rem;
            background: linear-gradient(145deg, var(--accent-1), var(--accent-2));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        /* Theme Toggle */
        .theme-switcher {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-secondary);
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: linear-gradient(145deg, var(--accent-1), var(--accent-2));
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        /* Game Tabs */
        .game-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .game-tab {
            padding: 10px 20px;
            background: var(--card-bg);
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            border: var(--border);
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .game-tab:hover, .game-tab.active {
            background: linear-gradient(145deg, var(--accent-1), var(--accent-2));
            color: var(--game-btn-text);
            transform: translateY(-2px);
        }

        /* Game Content */
        .game-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: var(--border);
            min-height: 400px;
        }

        /* Game Controls */
        .game-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .game-btn {
            background: linear-gradient(145deg, var(--accent-1), var(--accent-2));
            color: var(--game-btn-text);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .game-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Chess Board */
        #chess-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
            width: fit-content;
            margin: 20px auto;
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 8px;
        }

        .chess-square {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0d9b5;
            position: relative;
        }

        .chess-square.dark {
            background-color: #b58863;
        }

        .chess-piece {
            font-size: 24px;
            position: absolute;
        }

        /* Ludo Board */
        #ludo-board {
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1/1;
            margin: 0 auto;
            background: var(--bg-secondary);
            border-radius: 8px;
            position: relative;
        }

        .ludo-piece {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            position: absolute;
            transition: all 0.3s ease;
        }

        /* Leaderboard */
        .leaderboard-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .filter-btn {
            padding: 8px 15px;
            background: var(--card-bg);
            border: var(--border);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn.active, .filter-btn:hover {
            background: linear-gradient(145deg, var(--accent-1), var(--accent-2));
            color: var(--game-btn-text);
        }

        .leaderboard-entry {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            background-color: var(--card-bg);
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .leaderboard-entry:hover {
            transform: translateX(5px);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .rank {
            font-weight: bold;
            margin-right: 10px;
            color: var(--accent-1);
        }

        .username {
            flex-grow: 1;
            text-align: left;
            margin: 0 10px;
        }

        .score {
            font-weight: bold;
            color: var(--accent-2);
        }

        /* Settings */
        .setting-option {
            margin-bottom: 25px;
        }

        .setting-option h3 {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--bg-secondary);
            transition: transform 0.2s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .bg-select {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            background: var(--card-bg);
            border: var(--border);
            color: var(--text-primary);
        }

        /* User Profile */
        #user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Customization Panel */
        .customization-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        .customize-btn {
            background: linear-gradient(145deg, var(--accent-1), var(--accent-2));
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .customize-btn:hover {
            transform: rotate(15deg) scale(1.1);
        }

        .customization-menu {
            position: absolute;
            bottom: 60px;
            right: 0;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            width: 250px;
            box-shadow: var(--shadow);
            border: var(--border);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .customization-menu.show {
            display: block;
        }

        /* Error Message */
        .error-message {
            background-color: var(--error);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            animation: fadeIn 0.5s ease;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .game-tabs {
                justify-content: center;
            }

            .game-controls {
                flex-direction: column;
            }

            #chess-board {
                width: 100%;
            }

            .chess-square {
                width: 100%;
                aspect-ratio: 1/1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">‚ú® Ultimate Anime Game Bot</h1>
            <div class="theme-switcher">
                <i class="fas fa-moon"></i>
                <label class="switch">
                    <input type="checkbox" id="theme-toggle">
                    <span class="slider"></span>
                </label>
                <i class="fas fa-sun"></i>
            </div>
        </div>

        <div class="game-tabs">
            <div class="game-tab active" data-game="chess">‚ôüÔ∏è Chess</div>
            <div class="game-tab" data-game="ludo">üé≤ Ludo</div>
            <div class="game-tab" data-game="leaderboard">üèÜ Leaderboard</div>
            <div class="game-tab" data-game="settings">‚öôÔ∏è Settings</div>
        </div>

        <div class="game-content" id="game-content">
            <!-- Chess Game -->
            <div id="chess-game" class="game-section">
                <h2>‚ôüÔ∏è Anime Chess</h2>
                <p>Play chess with anime-themed pieces against friends or AI!</p>
                <div id="chess-board"></div>
                <div class="game-controls">
                    <button class="game-btn" id="start-chess">
                        <i class="fas fa-play"></i> Start Game
                    </button>
                    <button class="game-btn" id="submit-chess-score">
                        <i class="fas fa-trophy"></i> Submit Score
                    </button>
                </div>
                <div id="chess-score-display" style="display: none;">
                    Current Score: <span id="current-chess-score">0</span>
                </div>
            </div>

            <!-- Ludo Game -->
            <div id="ludo-game" class="game-section" style="display:none;">
                <h2>üé≤ Anime Ludo</h2>
                <p>Challenge your friends in this anime-style ludo game!</p>
                <div id="ludo-board"></div>
                <div class="game-controls">
                    <button class="game-btn" id="roll-ludo-dice">
                        <i class="fas fa-dice"></i> Roll Dice
                    </button>
                    <button class="game-btn" id="submit-ludo-score">
                        <i class="fas fa-trophy"></i> Submit Score
                    </button>
                </div>
                <div id="ludo-score-display" style="display: none;">
                    Current Score: <span id="current-ludo-score">0</span>
                </div>
            </div>

            <!-- Leaderboard -->
            <div id="leaderboard" class="game-section" style="display:none;">
                <h2>üèÜ Top Players</h2>
                <div class="leaderboard-filters">
                    <button class="filter-btn active" data-filter="all">All Games</button>
                    <button class="filter-btn" data-filter="chess">Chess</button>
                    <button class="filter-btn" data-filter="ludo">Ludo</button>
                </div>
                <div id="leaderboard-entries"></div>
            </div>

            <!-- Settings -->
            <div id="settings" class="game-section" style="display:none;">
                <h2>‚öôÔ∏è Customize Your Experience</h2>
                
                <div class="setting-option">
                    <h3><i class="fas fa-palette"></i> Theme Colors</h3>
                    <div class="color-options">
                        <div class="color-option" style="background: #ff6b9e;" data-colors="#ff6b9e,#6b47ff" title="Pink-Purple"></div>
                        <div class="color-option" style="background: #ff3366;" data-colors="#ff3366,#6633ff" title="Red-Purple"></div>
                        <div class="color-option" style="background: #00b894;" data-colors="#00b894,#0984e3" title="Teal-Blue"></div>
                        <div class="color-option" style="background: #fdcb6e;" data-colors="#fdcb6e,#e17055" title="Yellow-Orange"></div>
                        <div class="color-option" style="background: #6c5ce7;" data-colors="#6c5ce7,#a29bfe" title="Purple-Lavender"></div>
                        <div class="color-option" style="background: #00cec9;" data-colors="#00cec9,#fd79a8" title="Turquoise-Pink"></div>
                    </div>
                </div>
                
                <div class="setting-option">
                    <h3><i class="fas fa-image"></i> Background</h3>
                    <select id="bg-select" class="bg-select">
                        <option value="https://i.imgur.com/X6QX0yT.png">Dark Anime</option>
                        <option value="https://i.imgur.com/Lw7JYrQ.png">Bright Anime</option>
                        <option value="https://i.imgur.com/zYVp4aA.jpg">Cherry Blossom</option>
                        <option value="https://i.imgur.com/8nL5Q7z.jpg">Cyberpunk</option>
                        <option value="none">No Background</option>
                    </select>
                </div>
                
                <div class="setting-option">
                    <h3><i class="fas fa-user"></i> Profile</h3>
                    <div id="user-profile">
                        <img id="user-avatar" src="https://i.imgur.com/JRlq1Fs.png" width="50" height="50" style="border-radius: 50%;">
                        <span id="username-display">Guest</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customization Floating Button -->
    <div class="customization-panel">
        <div class="customization-menu" id="customization-menu">
            <h3><i class="fas fa-magic"></i> Quick Customize</h3>
            <div class="color-options">
                <div class="color-option" style="background: #ff6b9e;" data-colors="#ff6b9e,#6b47ff"></div>
                <div class="color-option" style="background: #00b894;" data-colors="#00b894,#0984e3"></div>
                <div class="color-option" style="background: #6c5ce7;" data-colors="#6c5ce7,#a29bfe"></div>
            </div>
            <button class="game-btn" id="toggle-theme">
                <i class="fas fa-adjust"></i> Toggle Theme
            </button>
        </div>
        <button class="customize-btn" id="customize-button">
            <i class="fas fa-palette"></i>
        </button>
    </div>

    <script>
        // Telegram WebApp initialization
        const tg = window.Telegram.WebApp;
        if (!tg || !tg.initDataUnsafe) {
            document.body.innerHTML = `
                <div class="error-message">
                    <h2>‚ö†Ô∏è Telegram WebApp Required</h2>
                    <p>This game must be run within the Telegram app.</p>
                </div>
            `;
            throw new Error('Telegram WebApp API not found');
        }
        
        tg.expand(); // Expand the WebApp to full view
        tg.enableClosingConfirmation(); // Prevent accidental closing

        // Game state
        let currentGame = null;
        let gameActive = false;
        let currentChessScore = 0;
        let currentLudoScore = 0;
        let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
        let currentFilter = 'all';
        
        // User data
        const user = tg.initDataUnsafe.user || {};
        const username = user.username || `Player${Math.floor(Math.random() * 1000)}`;
        const userPhoto = user.photo_url || 'https://i.imgur.com/JRlq1Fs.png';

        // DOM Elements
        const elements = {
            gameTabs: document.querySelectorAll('.game-tab'),
            filterBtns: document.querySelectorAll('.filter-btn'),
            colorOptions: document.querySelectorAll('.color-option'),
            startChessBtn: document.getElementById('start-chess'),
            submitChessBtn: document.getElementById('submit-chess-score'),
            rollLudoBtn: document.getElementById('roll-ludo-dice'),
            submitLudoBtn: document.getElementById('submit-ludo-score'),
            themeToggle: document.getElementById('theme-toggle'),
            toggleThemeBtn: document.getElementById('toggle-theme'),
            customizeBtn: document.getElementById('customize-button'),
            customizationMenu: document.getElementById('customization-menu'),
            bgSelect: document.getElementById('bg-select'),
            chessBoard: document.getElementById('chess-board'),
            ludoBoard: document.getElementById('ludo-board'),
            leaderboardEntries: document.getElementById('leaderboard-entries'),
            chessScoreDisplay: document.getElementById('chess-score-display'),
            ludoScoreDisplay: document.getElementById('ludo-score-display'),
            currentChessScore: document.getElementById('current-chess-score'),
            currentLudoScore: document.getElementById('current-ludo-score'),
            userAvatar: document.getElementById('user-avatar'),
            usernameDisplay: document.getElementById('username-display')
        };

        // Initialize games
        function initGames() {
            setupEventListeners();
            initChessBoard();
            initLudoBoard();
            loadPreferences();
            setupUserProfile();
            showGame('chess'); // Start with chess by default
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Game tab navigation
            elements.gameTabs.forEach(tab => {
                tab.addEventListener('click', () => showGame(tab.dataset.game));
            });

            // Leaderboard filters
            elements.filterBtns.forEach(btn => {
                btn.addEventListener('click', () => filterLeaderboard(btn.dataset.filter));
            });

            // Color theme options
            elements.colorOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const colors = option.dataset.colors.split(',');
                    setThemeColors(colors[0], colors[1]);
                });
            });

            // Game controls
            elements.startChessBtn.addEventListener('click', startChessGame);
            elements.submitChessBtn.addEventListener('click', () => submitScore('chess', currentChessScore));
            elements.rollLudoBtn.addEventListener('click', rollLudoDice);
            elements.submitLudoBtn.addEventListener('click', () => submitScore('ludo', currentLudoScore));

            // Theme management
            elements.themeToggle.addEventListener('change', toggleTheme);
            elements.toggleThemeBtn.addEventListener('click', toggleTheme);

            // Customization panel
            elements.customizeBtn.addEventListener('click', toggleCustomizationMenu);
            elements.bgSelect.addEventListener('change', (e) => changeBackground(e.target.value));

            // Close customization menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.customization-panel')) {
                    elements.customizationMenu.classList.remove('show');
                }
            });
        }

        // Chess game functions
        function initChessBoard() {
            let html = '';
            const pieces = ['‚ôú', '‚ôû', '‚ôù', '‚ôõ', '‚ôö', '‚ôù', '‚ôû', '‚ôú'];
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const isDark = (row + col) % 2 !== 0;
                    let piece = '';
                    
                    // Add pieces
                    if (row === 0) piece = `<span class="chess-piece" style="color: #333;">${pieces[col]}</span>`;
                    if (row === 1) piece = '<span class="chess-piece" style="color: #333;">‚ôü</span>';
                    if (row === 6) piece = '<span class="chess-piece">‚ôô</span>';
                    if (row === 7) piece = `<span class="chess-piece">${pieces[col]}</span>`;
                    
                    html += `
                        <div class="chess-square ${isDark ? 'dark' : ''}" data-row="${row}" data-col="${col}">
                            ${piece}
                        </div>
                    `;
                }
            }
            elements.chessBoard.innerHTML = html;

            // Add chess square click handlers
            document.querySelectorAll('.chess-square').forEach(square => {
                square.addEventListener('click', handleChessMove);
            });
        }

        function handleChessMove(e) {
            if (!gameActive || currentGame !== 'chess') return;
            
            const square = e.currentTarget;
            square.classList.toggle('highlight');
            currentChessScore += 5; // Simple scoring for demo
            elements.currentChessScore.textContent = currentChessScore;
            elements.chessScoreDisplay.style.display = 'block';
        }

        function startChessGame() {
            currentGame = 'chess';
            gameActive = true;
            currentChessScore = 0;
            elements.currentChessScore.textContent = '0';
            elements.chessScoreDisplay.style.display = 'none';
            
            // Reset board highlights
            document.querySelectorAll('.chess-square').forEach(sq => {
                sq.classList.remove('highlight');
            });
            
            tg.showAlert("‚ôü Chess game started! Click on squares to capture pieces!");
        }

        // Ludo game functions
        function initLudoBoard() {
            elements.ludoBoard.innerHTML = '';
            
            // Create Ludo board paths
            const colors = ['#FF5252', '#4CAF50', '#2196F3', '#FFC107'];
            const paths = [
                {top: '10%', left: '10%'}, // Red
                {top: '10%', left: '70%'}, // Green
                {top: '70%', left: '10%'}, // Blue
                {top: '70%', left: '70%'}  // Yellow
            ];
            
            colors.forEach((color, i) => {
                const path = document.createElement('div');
                path.style.position = 'absolute';
                path.style.width = '20%';
                path.style.height = '20%';
                path.style.top = paths[i].top;
                path.style.left = paths[i].left;
                path.style.backgroundColor = `${color}20`;
                path.style.borderRadius = '50%';
                path.style.border = `2px solid ${color}`;
                elements.ludoBoard.appendChild(path);
            });
            
            // Create home areas
            const home = document.createElement('div');
            home.style.position = 'absolute';
            home.style.width = '20%';
            home.style.height = '20%';
            home.style.top = '40%';
            home.style.left = '40%';
            home.style.backgroundColor = 'var(--card-bg)';
            home.style.borderRadius = '50%';
            home.style.display = 'flex';
            home.style.justifyContent = 'center';
            home.style.alignItems = 'center';
            home.innerHTML = '<span style="font-size: 24px;">üèÅ</span>';
            elements.ludoBoard.appendChild(home);
        }

        function rollLudoDice() {
            if (!gameActive || currentGame !== 'ludo') {
                tg.showAlert("Please start a new Ludo game first!");
                return;
            }
            
            const roll = Math.floor(Math.random() * 6) + 1;
            currentLudoScore += roll * 5; // Simple scoring for demo
            elements.currentLudoScore.textContent = currentLudoScore;
            elements.ludoScoreDisplay.style.display = 'block';
            
            tg.showAlert(`üé≤ You rolled a ${roll}! Score increased by ${roll * 5} points!`);
        }

        function startLudoGame() {
            currentGame = 'ludo';
            gameActive = true;
            currentLudoScore = 0;
            elements.currentLudoScore.textContent = '0';
            elements.ludoScoreDisplay.style.display = 'none';
            tg.showAlert("üé≤ Ludo game started! Roll the dice to begin!");
        }

        // Leaderboard functions
        function updateLeaderboard() {
            let filteredEntries = currentFilter === 'all' 
                ? leaderboard 
                : leaderboard.filter(entry => entry.game === currentFilter);
            
            let html = filteredEntries.length > 0 
                ? filteredEntries.map((entry, index) => `
                    <div class="leaderboard-entry">
                        <span class="rank">${index + 1}.</span>
                        ${entry.avatar ? `<img src="${entry.avatar}" class="user-avatar">` : ''}
                        <span class="username">${entry.username}</span>
                        <span class="score">${entry.score} pts</span>
                    </div>
                `).join('')
                : '<p>No scores yet for this game. Be the first!</p>';
            
            elements.leaderboardEntries.innerHTML = html;
        }

        function filterLeaderboard(filter) {
            currentFilter = filter;
            elements.filterBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            updateLeaderboard();
        }

        // Score submission
        function submitScore(gameType, score) {
            if (!gameActive) {
                tg.showAlert('‚ö†Ô∏è No active game to submit score from');
                return;
            }

            if (typeof score !== 'number' || score <= 0) {
                tg.showAlert('‚ö†Ô∏è Invalid score value');
                return;
            }

            try {
                leaderboard.push({
                    username,
                    score,
                    game: gameType,
                    date: new Date().toISOString(),
                    avatar: userPhoto
                });
                
                // Keep only top 25 scores
                leaderboard.sort((a, b) => b.score - a.score);
                while (leaderboard.length > 25) leaderboard.pop();
                
                localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
                tg.showAlert(`üéâ Score of ${score} saved to ${gameType} leaderboard!`);
                
                gameActive = false;
                if (currentFilter === 'all' || currentFilter === gameType) {
                    updateLeaderboard();
                }
            } catch (error) {
                console.error('Score submission failed:', error);
                tg.showAlert('‚ö†Ô∏è Failed to save score. Please try again.');
            }
        }

        // Theme management
        function toggleTheme() {
            document.body.classList.toggle('bright-theme');
            localStorage.setItem('theme', document.body.classList.contains('bright-theme') ? 'bright' : 'dark');
            elements.themeToggle.checked = document.body.classList.contains('bright-theme');
        }

        function setThemeColors(accent1, accent2) {
            document.documentElement.style.setProperty('--accent-1', accent1);
            document.documentElement.style.setProperty('--accent-2', accent2);
            localStorage.setItem('accent1', accent1);
            localStorage.setItem('accent2', accent2);
            toggleCustomizationMenu(); // Close after selection
        }

        function changeBackground(bgUrl) {
            if (bgUrl === 'none') {
                document.documentElement.style.setProperty('--bg-image', 'none');
            } else {
                document.documentElement.style.setProperty('--bg-image', `url('${bgUrl}')`);
            }
            localStorage.setItem('background', bgUrl);
        }

        // User profile
        function setupUserProfile() {
            elements.userAvatar.src = userPhoto;
            elements.usernameDisplay.textContent = username;
        }

        // Game navigation
        function showGame(gameName) {
            document.querySelectorAll('.game-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(`${gameName}-game`).style.display = 'block';
            
            // Update active tab
            elements.gameTabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.game === gameName);
            });
            
            if (gameName === 'leaderboard') {
                updateLeaderboard();
            }
            
            currentGame = gameName === 'chess' || gameName === 'ludo' ? gameName : null;
        }

        // Customization panel
        function toggleCustomizationMenu() {
            elements.customizationMenu.classList.toggle('show');
        }

        // Load saved preferences
        function loadPreferences() {
            // Theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'bright') {
                document.body.classList.add('bright-theme');
                elements.themeToggle.checked = true;
            }
            
            // Colors
            const savedAccent1 = localStorage.getItem('accent1');
            const savedAccent2 = localStorage.getItem('accent2');
            if (savedAccent1 && savedAccent2) {
                setThemeColors(savedAccent1, savedAccent2);
            }
            
            // Background
            const savedBg = localStorage.getItem('background');
            if (savedBg) {
                changeBackground(savedBg);
                elements.bgSelect.value = savedBg;
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initGames);
    </script>
</body>
    </html>
